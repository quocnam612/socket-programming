\section{Quy trình thực hiện}

\subsection{Xây dựng RTP/RTSP server và client (4đ)}
Các file trong phần này nằm trong thư mục \textbf{1\_RTSP\_RTP}

\subsubsection{Hoàn thiện Client.py - Giao thức RTSP của client}
Mô hình trang thái của client:
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{img/states.png}
    \caption{Sơ đồ trạng thái và chuyển đổi của client RTSP}
\end{figure}

Hoàn thiện hàm gửi RTSP request - sendRtspRequest(): 
\lstinputlisting[language=Python]{code/sendRtspRequest.py}
\begin{itemize}
    \item Hàm build chuỗi request theo từng trạng thái INIT/READY/PLAYING. Mỗi lần gửi đều tăng \texttt{CSeq} để server đồng bộ và gắn \texttt{Session} với các request sau \texttt{SETUP}.
    \item Với \texttt{SETUP} client khởi tạo luồng nhận phản hồi song song, còn \texttt{PLAY}, \texttt{PAUSE}, \texttt{TEARDOWN} chỉ đơn giản tạo request tương ứng.
    \item Sau khi dựng xong, request được encode và đẩy qua socket TCP tới server RTSP.
\end{itemize}


Hoàn thiện hàm phân tích RTSP reply - parseRtspReply(): 
\lstinputlisting[language=Python]{code/parseRtspReply.py}
\begin{itemize}
    \item Phản hồi được tách theo từng dòng để lấy \texttt{CSeq} và \texttt{Session}. Client chỉ xử lý khi số thứ tự trùng với gói vừa gửi để tránh trạng thái cũ.
    \item Khi mã trạng thái 200 OK, client cập nhật máy trạng thái: \texttt{READY} sau \texttt{SETUP}, \texttt{PLAYING} sau \texttt{PLAY}, quay về \texttt{READY} sau \texttt{PAUSE} và về \texttt{INIT} khi \texttt{TEARDOWN}.
    \item Riêng \texttt{SETUP} sẽ mở cổng RTP để chờ dữ liệu video, \texttt{PAUSE} giải phóng event phát và \texttt{TEARDOWN} đánh dấu đã nhận ACK để đóng kết nối.
\end{itemize}

Hoàn thiện hàm kết nối tới port của RTP - openRtpPort(): 
\lstinputlisting[language=Python]{code/openRtpPort.py}
\begin{itemize}
    \item Client khởi tạo socket UDP (\texttt{AF\_INET, SOCK\_DGRAM}) cùng timeout ngắn để việc nhận khung không bị block.
    \item Hàm bind trực tiếp vào \texttt{rtpPort}; nếu cổng đã được sử dụng, người dùng được cảnh báo bằng hộp thoại Tkinter để đổi port.
\end{itemize}

\subsubsection{Hoàn thiện RtpPacket.py - Giao thức RTP của server}
Hoàn thiện hàm encapsulation - encode(): 
\lstinputlisting[language=Python]{code/encode.py}
\textbf{header}: mảng byte có kích thước 12 bytes
\begin{itemize}
    \item Byte thứ 1 (8 bits): chứa trường Version, Padding, Extension, Contributing Source Count và có dạng V-V-P-X-CC-CC-CC-CC
    \begin{itemize}
        \item version \& 0x03: lấy 2 bit cuối của version (03[16] = 0000 0011[2])
        \item << 6: dịch trái 6 bit để đưa về vị trí 2 bit đầu tiên trong byte (eg. V = 2 => 1100 0000[2])
        \item Tương tự với các trường padding, extension, lúc này còn 4 bit cuối cùng là CC
        \item cc \& 0x0F: chỉ lấy 4 bit cuối của cc (0F[16] = 0000 1111[2])
    \end{itemize}
    \item Byte thứ 2 (8 bits): chứa trường Marker Bit, Payload Type và có dạng M-PT-PT-PT-PT-PT-PT-PT (các logic tương tự byte 1)
    \item Byte thứ 3-4 (16 bits): chỉ chứa trường Sequence Number
    \begin{itemize}
        \item (seqnum >> 8) \& 0xFF: lấy 8 bit đầu của seqnum (0xFF[16] = 1111 1111[2])
        \item seqnum \& 0xFF: lấy 8 bit cuối của seqnum
    \end{itemize}
    \item Byte thứ 5-8 (32 bits): chỉ chứa trường Timestamp, logic tương tự byte 3-4
    \item Byte thứ 9-12 (32 bits): chỉ chứa trường Synchronization Source Identifier (SSRC), logic tương tự byte 3-4
\end{itemize}

Phần header trong python sẽ có dạng như sau, với mỗi dòng tương ứng với 4 bytes (32 bits):
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{img/realRTP.png}
    \caption{Cấu trúc mảng header}
\end{figure} 

\subsubsection{Thử nghiệm}
Thực hiện chạy server RTSP/RTP và client RTSP trên cùng máy tính với video mẫu qua câu lệnh:
\begin{itemize}
    \item Ternimal 1: chạy server RTSP/RTP (python Server.py \textbf{<PORT>}). Ví Dụ:
    \begin{lstlisting}[language=bash] 
python 1_RTSP_RTP/Server.py 8089 \end{lstlisting}
    \item Ternimal 2: chạy client RTSP (python ClientLauncher.py \textbf{<SERVER\_IP>} \textbf{<RTSP\_PORT>} \textbf{<RTP\_PORT>} \textbf{<VIDEO\_FILE>}). Ví Dụ:
    \begin{lstlisting}[language=bash] 
python 1_RTSP_RTP/ClientLauncher.py 127.0.0.1 8089 8090 video/movie288.Mjpeg \end{lstlisting}
\end{itemize}
Output thu được khi chọn các nút (Setup -> Play -> Pause) trên giao diện client:
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{img/1-demoOuput.png}
    \caption{Output RTSP client}
\end{figure}
Có thể thấy client đã gửi đúng các request RTSP và chạy được video qua giao thức RTP. \\
\textbf{Nhược điểm:} Với video có độ phân giải cao (HD trở lên) khi 1 frame vượt quá kích thước gói UDP sẽ bị tràng byte qua các gói khác, dẫn đến việc giải mã sai frame tiếp theo và báo lỗi.

\subsection{Bổ sung HD video streaming (3đ)}
Các file trong phần này nằm trong thư mục \textbf{2\_HD\_Video\_Streaming}. \\
Đây là phiên bản nâng cấp của phần 1 nhằm hỗ trợ streaming video có độ phân giải cao (HD - 720p, Full HD - 1080p, 2K - 1440p). \\

\subsubsection{Ý tưởng}
Khắc phục nhược điểm của phần 1 bằng cách chia nhỏ frame video thành các mảnh (fragment) có kích thước phù hợp với gói UDP dựa trên MTU - Maximum transmission unit (dưới 1500 bytes).

\begin{table}[H]
\centering
\renewcommand{\arraystretch}{1.2}
\begin{tabular}{|p{4cm}|p{5cm}|p{7cm}|}
\hline
\textbf{Các phương tiện truyền tải qua IP} & \textbf{MTU (bytes)} & \textbf{Notes} \\ \hline
Internet IPv4 path MTU & Tối thiểu 68 bytes, tối đa 64 KiB & Nên dùng Path MTU Discovery để tìm MTU thực tế trên đường đi; nếu router phải giảm MTU sẽ xảy ra IP fragmentation. \\ \hline
Internet IPv6 path MTU & Tối thiểu 1280 bytes, tối đa 64 KiB & Yêu cầu Path MTU Discovery trừ khi giữ nguyên mức tối thiểu 1280; jumbo gram với Jumbo Payload option cho phép payload từ 65\,536 đến ~4.3 tỉ octet. \\ \hline
X.25 & 576 bytes khi gửi hoặc 1600 bytes khi nhận & Chuẩn X.25 quy định hai ngưỡng MTU khác nhau cho chiều gửi và nhận. \\ \hline
Ethernet v2 & 1500 bytes & Phần lớn triển khai IP over Ethernet đều dùng frame Ethernet II nên bị giới hạn bởi MTU 1500 bytes. \\ \hline
... & ... & ... \\ \hline
\end{tabular}
\caption{Một số MTU cho các phương tiện truyền tải phổ biến}
\end{table}

Mỗi fragment sẽ được đóng gói trong một gói RTP riêng biệt với đầy đủ header và payload. Client sẽ nhận các gói RTP, tái tạo lại các fragment và ghép chúng lại thành frame hoàn chỉnh bằng cách nhận diện các SOI, EOI trong payload (Marker Bit không được sử dụng do đã bị giới hạn giá trị bằng 0). \\

\textbf{Nhược điểm:} Dù đã gửi và chạy được nhưng với các video có độ phải cao hơn (1440p, 2160p,...) các frame tải chậm hơn tốc độ của video dẫn tới tình trạng mất frame và drop FPS nặng.

\subsection{Bổ sung client cache (2.5đ)}
Các file trong phần này nằm trong thư mục \textbf{3\_Client\_Cache}. \\
Đây là phiên bản nâng cấp của phần 2 và cũng là phiên bảng cuối cùng nhằm cải thiện trải nghiệm xem video HD bằng cách thêm bộ đệm (buffer) trên client. \\

\subsubsection{Ý tưởng}
Khắc phục nhược điểm của phần 2 bằng cách thêm bộ đệm (buffer) trên client để lưu trữ trước một số frame video nhất định trước khi phát. Khi người dùng nhấn Play, client sẽ bắt đầu nhận các gói RTP và lưu trữ các frame vào bộ đệm cho đến khi đạt ngưỡng đã định sẵn (ví dụ: 30 frame). Sau đó, client mới bắt đầu phát video từ bộ đệm trong khi tiếp tục nhận và lưu trữ các frame mới vào bộ đệm. Điều này giúp đảm bảo rằng có đủ frame để phát liên tục ngay cả khi tốc độ tải về chậm hơn tốc độ phát video. \\

\subsubsection{Thử nghiệm}
Thực hiện chạy server RTSP/RTP và client RTSP trên cùng máy tính với video mẫu qua câu lệnh:
\begin{itemize}
    \item Ternimal 1: chạy server RTSP/RTP (python Server.py \textbf{<PORT>}). Ví Dụ:
    \begin{lstlisting}[language=bash] 
python 1_RTSP_RTP/Server.py 8089 \end{lstlisting}
    \item Ternimal 2: chạy client RTSP (python ClientLauncher.py \textbf{<SERVER\_IP>} \textbf{<RTSP\_PORT>} \textbf{<RTP\_PORT>} \textbf{<VIDEO\_FILE>}). Ví Dụ:
    \begin{lstlisting}[language=bash] 
python 1_RTSP_RTP/ClientLauncher.py 127.0.0.1 8089 8090 video/movie288.Mjpeg \end{lstlisting}
\end{itemize}
Output thu được khi chọn các nút (Setup -> Play -> Pause) trên giao diện client:
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{img/1-demoOuput.png}
    \caption{Output RTSP client}
\end{figure}
